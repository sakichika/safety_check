<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>安否報告 / Safety Status Report</title>
    <style>
      :root { --muted:#666; --border:#ddd; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      form { max-width: 820px; }
      fieldset { border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: .5rem; }
      legend { font-weight: 600; }
      label { display:block; margin:.6rem 0 .25rem; font-weight: 600; }
      small { color: var(--muted); display:block; }
      input, select, textarea { width: 100%; padding: .55rem; border:1px solid var(--border); border-radius:.35rem; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .ok { background:#e8fff0; padding:.75rem; border-left:4px solid #22aa55; margin-bottom:1rem; }
      .muted { color:var(--muted); }
      .req::after { content:" *"; color:#c00; font-weight:700; }
      .hint { font-size:.9rem; color: var(--muted); margin-top:.25rem; }
      button { padding:.6rem 1rem; border:1px solid #888; background:#f8f8f8; border-radius:.4rem; cursor:pointer; }
    </style>
  </head>
  <body>
    <h1>安否報告 / <span lang="en">Safety Status Report</span></h1>

    {% if period %}
      <p class="muted">
        現在の受付期間: #{{ period.seq }} ／ 開始 {{ period.started_at }}<br>
        <span lang="en">Current reporting period: #{{ period.seq }} — started at {{ period.started_at }}</span>
      </p>
    {% else %}
      <p class="muted">
        現在、受付期間は開始されていません。<br>
        <span lang="en">No active reporting period.</span>
      </p>
    {% endif %}

    {% if request.query_params.get('ok') %}
      <div class="ok">
        報告を受け付けました（再送で上書き可）。<br>
        <span lang="en">Your report has been received (resubmit to update).</span>
      </div>
    {% endif %}

    <form action="/public/report" method="post">
      <fieldset>
        <legend>本人確認 / <span lang="en">Identity</span></legend>

        <label class="req" for="grade">属性 / <span lang="en">Affiliation</span></label>
        <select id="grade" name="grade" required>
          <option value="">選択してください / <span lang="en">Select</span></option>
          <option>Staff</option>
          <option>Doctor</option>
          <option>Master</option>
          <option>Bachelor</option>
        </select>

        <label class="req" for="name">氏名 / <span lang="en">Name</span></label>
        <select id="name" name="name" required>
          <option value="">先に属性を選択してください / <span lang="en">Select affiliation first</span></option>
        </select>

        <label class="req" for="email">連絡用メール / <span lang="en">Contact email</span></label>
        <input id="email" name="email" type="email" required placeholder="you@example.com" />
        <small class="hint">
          メールは本人特定には使いません。連絡のために必須です。<br>
          <span lang="en">Email is required for contact only; identity is determined by affiliation + name.</span>
        </small>
      </fieldset>

      <fieldset>
        <legend>安否・避難先 / <span lang="en">Status & Shelter</span></legend>

        <label class="req" for="status">安否状況 / <span lang="en">Safety status</span></label>
        <select id="status" name="status" required>
          <option value="safe">無事 / <span lang="en">Safe</span></option>
          <option value="evacuating">避難中 / <span lang="en">Evacuating</span></option>
          <option value="need_help">支援が必要 / <span lang="en">Need help</span></option>
          <option value="unknown">不明 / <span lang="en">Unknown</span></option>
        </select>

        <div class="row">
          <div>
            <label for="shelter_type">避難先の種類（任意） / <span lang="en">Shelter type (optional)</span></label>
            <select id="shelter_type" name="shelter_type">
              <option value="">未選択 / <span lang="en">Not specified</span></option>
              <option value="home">自宅 / <span lang="en">Home</span></option>
              <option value="relative">親類・知人宅 / <span lang="en">Family/Friends</span></option>
              <option value="school">学内 / <span lang="en">Campus</span></option>
              <option value="public">公的避難所 / <span lang="en">Public shelter</span></option>
              <option value="other">その他 / <span lang="en">Other</span></option>
            </select>
          </div>
          <div>
            <label for="shelter_name">避難先名称（任意） / <span lang="en">Shelter name (optional)</span></label>
            <input id="shelter_name" name="shelter_name" placeholder="例: ○○小学校 / e.g., ABC Elementary" />
          </div>
        </div>

        <label for="shelter_addr">住所（任意） / <span lang="en">Address (optional)</span></label>
        <input id="shelter_addr" name="shelter_addr" placeholder="例: 東京都千代田区… / e.g., 1-1-1, Chiyoda, Tokyo" />
      </fieldset>

      <fieldset>
        <legend>被害状況（任意） / <span lang="en">Damage (optional)</span></legend>

        <label for="damage_level">被害レベル / <span lang="en">Damage level</span></label>
        <select id="damage_level" name="damage_level">
          <option value="">未選択 / <span lang="en">Not specified</span></option>
          <option value="none">なし / <span lang="en">None</span></option>
          <option value="minor">軽微 / <span lang="en">Minor</span></option>
          <option value="moderate">中程度 / <span lang="en">Moderate</span></option>
          <option value="severe">重大 / <span lang="en">Severe</span></option>
        </select>

        <label for="damage_notes">詳細 / <span lang="en">Details</span></label>
        <textarea id="damage_notes" name="damage_notes" rows="4"
          placeholder="例: 家屋のひび割れ、停電など / e.g., Cracks in walls, power outage"></textarea>
      </fieldset>

      <button type="submit">送信する / <span lang="en">Submit</span></button>
    </form>

    <script>
      async function loadRoster() {
        try {
          const res = await fetch('/public/roster', {cache:'no-store'});
          const data = await res.json(); // {Staff:[...], Doctor:[...], ...}
          const gradeSel = document.getElementById('grade');
          const nameSel  = document.getElementById('name');

          function refillNames() {
            const g = gradeSel.value;
            nameSel.innerHTML = '';
            const list = data[g] || [];
            if (list.length === 0) {
              nameSel.innerHTML = '<option value="">該当なし / <span lang="en">No entries</span></option>';
              return;
            }
            nameSel.appendChild(new Option('', ''));
            list.forEach(n => nameSel.appendChild(new Option(n, n)));
          }

          gradeSel.addEventListener('change', refillNames);
          // 初期表示（既に属性が選ばれていれば反映）
          if (gradeSel.value) refillNames();
        } catch (e) {
          console.error('roster load failed', e);
        }
      }
      loadRoster();
    </script>
  </body>
</html>
